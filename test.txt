public class TempFileUploadAction {

    // --- INNER CLASS FOR OUTPUT ---
    // This defines the structure of the data the Flow will receive.
    public class ActionOutput {
        @InvocableVariable(label='Temp File Upload ID' description='The Id of the Temp_File_Upload__c record found.')
        public Id tempFileUploadId;

        @InvocableVariable(label='Attachment File Name' description='The name of the related attachment file.')
        public String fileName;

        @InvocableVariable(label='File Content (Base64)' description='The Base64-encoded body of the file content.')
        public String fileBodyBase64;
    }
    
    // --- INNER CLASS FOR INPUT (If needed, but using simple List<String> is fine for just the name) ---
    // public class ActionInput { ... } 

    // --- INVOCABLE METHOD ---
    @InvocableMethod(label='Get Record and Attachment Data' description='Finds a Temp_File_Upload__c record by name and returns its related file content.')
    public static List<ActionOutput> getRecordAndAttachment(List<String> recordNames) {
        
        // 1. Initialize the results list. It must be a List of the output inner class.
        List<ActionOutput> results = new List<ActionOutput>();
        
        if (recordNames == null || recordNames.isEmpty()) {
            return results;
        }

        String targetName = recordNames[0];
        
        // --- STEP 1: Find the Temp_File_Upload__c Record ---
        Temp_File_Upload__c targetRecord = [
            SELECT Id
            FROM Temp_File_Upload__c
            WHERE Name = :targetName
            LIMIT 1
        ];

        if (targetRecord == null) {
            // Return an empty result if the record is not found.
            return results;
        }
        
        // --- STEP 2: Find the related ContentVersion ---
        // ContentDocumentLink links the record to the ContentDocument (File).
        // ContentVersion holds the actual file data and metadata. We get the latest version (IsLatest=true).
        List<ContentVersion> fileVersions = [
            SELECT Id, Title, VersionData, FileType
            FROM ContentVersion
            WHERE ContentDocumentId IN (
                SELECT ContentDocumentId
                FROM ContentDocumentLink
                WHERE LinkedEntityId = :targetRecord.Id
            )
            AND IsLatest = TRUE
            LIMIT 1
        ];

        // --- STEP 3: Package the Output ---
        ActionOutput output = new ActionOutput();
        output.tempFileUploadId = targetRecord.Id;

        if (!fileVersions.isEmpty()) {
            ContentVersion fileVersion = fileVersions[0];
            
            // The VersionData field is the Base64-encoded content of the file.
            output.fileName = fileVersion.Title + '.' + fileVersion.FileType;
            output.fileBodyBase64 = EncodingUtil.base64Encode(fileVersion.VersionData);
        }

        results.add(output);
        return results;
    }
}
