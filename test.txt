public class TempFileUploadAction {

    // --- INNER CLASS FOR OUTPUT ---
    public class ActionOutput {
        @InvocableVariable(label='Temp File Upload ID' description='The Id of the Temp_File_Upload__c record found.')
        public Id tempFileUploadId;

        @InvocableVariable(label='Attachment File Name' description='The name of the related attachment file.')
        public String fileName;

        @InvocableVariable(label='File Content (Base64)' description='The Base64-encoded body of the file content.')
        public String fileBodyBase64;
    }

    @InvocableMethod(label='Get Record and Attachment Data' description='Finds a Temp_File_Upload__c record by name and returns its related file content.')
    public static List<ActionOutput> getRecordAndAttachment(List<String> recordNames) {
        
        List<ActionOutput> results = new List<ActionOutput>();
        
        if (recordNames == null || recordNames.isEmpty()) {
            return results;
        }

        String targetName = recordNames[0];
        
        // --- STEP 1: Find the Temp_File_Upload__c Record ---
        Temp_File_Upload__c targetRecord = [
            SELECT Id
            FROM Temp_File_Upload__c
            WHERE Name = :targetName
            LIMIT 1
        ];

        if (targetRecord == null) {
            // Return an empty output object list if no record is found.
            results.add(new ActionOutput());
            return results;
        }

        // --- STEP 2: Query ContentDocumentLink to get the ContentDocumentId ---
        // This query must be separate because ContentDocumentLink is restricted.
        List<ContentDocumentLink> links = [
            SELECT ContentDocumentId
            FROM ContentDocumentLink
            WHERE LinkedEntityId = :targetRecord.Id
            LIMIT 1 // Assuming each record only has 1 attachment
        ];

        if (links.isEmpty()) {
            // Return empty output if the record is found but no file is attached.
            results.add(new ActionOutput());
            return results;
        }
        
        Id contentDocId = links[0].ContentDocumentId;

        // --- STEP 3: Query ContentVersion using the ContentDocumentId ---
        // We query ContentVersion for the file data (VersionData).
        List<ContentVersion> fileVersions = [
            SELECT Id, Title, VersionData, FileType
            FROM ContentVersion
            WHERE ContentDocumentId = :contentDocId
            AND IsLatest = TRUE
            LIMIT 1
        ];

        // --- STEP 4: Package the Output ---
        ActionOutput output = new ActionOutput();
        output.tempFileUploadId = targetRecord.Id;

        if (!fileVersions.isEmpty()) {
            ContentVersion fileVersion = fileVersions[0];
            
            // Encode the file body to Base64 to safely return it to the Flow.
            output.fileName = fileVersion.Title + '.' + fileVersion.FileType;
            output.fileBodyBase64 = EncodingUtil.base64Encode(fileVersion.VersionData);
        }

        results.add(output);
        return results;
    }
}
